#include <iostream>
#include <memory>
#include <cstring>
#include <fstream>
#include "../instructions/parser.hpp"
#include "chip8.hpp"
#include "../utils/format.hpp"

void Chip8::setFont() {
    static const uint8_t fontset[80] = {
        0xF0,0x90,0x90,0x90,0xF0, //0
        0x20,0x60,0x20,0x20,0x70, //1
        0xF0,0x10,0xF0,0x80,0xF0, //2
        0xF0,0x10,0xF0,0x10,0xF0, //3
        0x90,0x90,0xF0,0x10,0x10, //4
        0xF0,0x80,0xF0,0x10,0xF0, //5
        0xF0,0x80,0xF0,0x90,0xF0, //6
        0xF0,0x10,0x20,0x40,0x40, //7
        0xF0,0x90,0xF0,0x90,0xF0, //8
        0xF0,0x90,0xF0,0x10,0xF0, //9
        0xF0,0x90,0xF0,0x90,0x90, //A
        0xE0,0x90,0xE0,0x90,0xE0, //B
        0xF0,0x80,0x80,0x80,0xF0, //C
        0xE0,0x90,0x90,0x90,0xE0, //D
        0xF0,0x80,0xF0,0x80,0xF0, //E
        0xF0,0x80,0xF0,0x80,0x80  //F
    };
    memcpy(memory + 0x050, fontset, 80);
}

bool Chip8::loadRom(const std::string& path) {
    std::ifstream in(path, std::ios::binary);
    if (!in) return false;
    in.read(reinterpret_cast<char*>(memory + MEM_START), MEM_SIZE - MEM_START);
    rom_end = MEM_START + static_cast<uint16_t>(in.gcount());
    pc = MEM_START;
    return true;
}

void Chip8::step(std::vector<uint32_t>& frame_buffer, int frame_width, int frame_height, uint16_t keydown) {
    if (finished()) return;
    uint16_t opcode = (memory[pc] << 8) | memory[pc + 1];
    std::unique_ptr<Inst> inst = Chip8Parser::parse(opcode);
    pc += 2;
    inst->execute(*this, frame_buffer, frame_width, frame_height, keydown);
}
